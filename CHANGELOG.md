# 更新日志

本文档记录本项目的所有重要变更。

格式基于 [Keep a Changelog](https://keepachangelog.com/zh-CN/1.0.0/)，
版本号遵循扩展的语义化版本规范（x.y.z-w 格式）。

## [1.5.0-0] - 当前版本

### feat（新功能）
- 新增干员列表查询功能
  - 支持查询所有干员列表，按兵种分组显示
  - 命令：`^干员列表`
  - 自动根据干员ID判断兵种类型（突击、工程、支援、侦察）
  - 显示每个兵种的干员数量和列表
- 新增干员信息查询功能
  - 支持查询单个干员的详细信息
  - 命令：`^干员 名称`（例如：`^干员 乌鲁鲁`）
  - 显示干员全名、兵种、兵种描述、技能列表等信息
  - 支持模糊匹配，自动查找最匹配的干员
- 新增健康状态信息查询功能
  - 支持查询游戏健康状态相关信息
  - 命令：`^健康状态`
  - 显示负面状态列表（按部位分组：头、胸、腹、腿、手、全身）
  - 显示增益状态列表
  - 每个状态显示触发条件、效果等信息
  - 使用图片渲染模板展示，视觉效果更佳
- 新增地图统计查询功能
  - 支持查询各地图的详细统计数据
  - 命令：`^地图统计` 或 `#三角洲地图统计`
  - 支持按模式筛选（烽火地带/全面战场）
  - 支持按赛季筛选（全部赛季/指定赛季）
  - 支持按地图名称搜索
  - 支持合并显示所有基础地图数据（烽火+全面）
  - 烽火地带显示：净收益、总对局、撤离数、撤离率、击杀数、撤离失败
  - 全面战场显示：胜利、总对局、胜率、总得分、游戏时长、KDA、击杀、助攻、死亡

### style（样式）
- 新增特勤处信息渲染模板
- 新增干员信息渲染模板
  - 支持图片渲染，展示干员详细信息
  - 使用干员图片作为背景
  - 显示干员名称、全名、兵种、兵种描述
  - 展示技能列表，包括技能图标、名称和描述
- 新增健康状态信息渲染模板
  - 支持图片渲染，展示健康状态信息
  - 采用上下布局，负面状态在上，增益状态在下
  - 负面状态按部位分组显示，支持同一部位状态合并显示
  - 每个状态显示图标、名称、触发条件和效果
- 新增流水查询渲染模板
  - 支持设备、道具、货币三种流水类型的图片渲染
  - 使用五列网格布局，按行排序显示
  - 设备流水显示玩家信息、设备统计、IP统计等详细信息
  - 道具流水显示物品变化记录
  - 货币流水显示金额变化记录和资产余额变化趋势折线图
- 新增货币流水折线图功能
  - 按日期聚合数据，每个节点代表一个日期的余额
  - 显示资产余额变化趋势，包括起始余额、结束余额、最高余额、最低余额、总计变化
- 新增流水渲染模板（`flows.html` 和 `flows.css`）
- 新增货币流水折线图模板（`moneyTrendChart.html` 和 `moneyTrendChart.css`）
- 新增地图统计渲染模板（`mapStats.html` 和 `mapStats.css`）

### refactor（重构）
- 优化数据管理器（`utils/Data.js`）
  - 合并重复的数据加载函数：`loadLocalData` 和 `loadRankScoreData` 合并为统一的 `loadYamlData`
  - 合并重复的数据保存函数：`saveLocalData` 和 `saveRankScoreData` 合并为统一的 `saveYamlData`
  - 合并武器查询函数：`getWeaponByMode` 合并到 `getWeaponByName`，通过 `mode` 参数支持按模式查询
  - 移除未使用的函数：`getWeaponsByCaliber`、`getWeaponCategories`、`getWeaponsByCategory`
- 优化语音功能（`apps/entertainment/Voice.js`）
  - 使用 `isValidAudioCharacter` 验证角色名，优先识别已知角色
- 更新文档

### style（样式）
- 优化周报模板（`weeklyReport.html` 和 `weeklyReport.css`）
  - 新增干员图片占位符功能：当干员图片不存在或加载失败时显示"暂无图片"文字
- 优化战绩模板（`record.html` 和 `record.css`）
- 优化战绩推送模板（`recordPush.html` 和 `recordPush.css`）

## [1.4.0-0] - 历史版本

### feat（新功能）
- 新增特勤处信息查询功能
  - 支持查询特勤处设施的详细信息（升级条件、所需物品、解锁效果等）
  - 命令：`#三角洲特勤处信息` 或 `^特勤处信息`
  - 支持按类型筛选查询（仓库、指挥中心、工作台、技术中心、靶场、训练中心、制药台、防具台、收藏室、潜水中心）
  - 支持显示升级所需物品（从物品映射表获取名称）
  - 支持显示解锁效果（属性加成和道具列表）

## [1.3.0-0] - 历史版本

### feat（新功能）
- 战绩查询功能增强
  - 未指定模式时，自动查询并发送烽火地带和全面战场两种模式的战绩
  - 发送两张独立的图片，而非合并为一张图片
  - 指定模式时保持原有行为（只查询指定模式）
- 战绩订阅推送功能增强
  - 新增 isRecent 战绩批量合并转发功能
  - isRecent 战绩（首次连接时的旧战绩）自动收集并批量合并转发
  - 使用合并转发消息发送多条 isRecent 战绩，标题显示"最近的战绩"
  - 防抖机制：500ms 延迟批量发送，新战绩会重置定时器
  - 按推送目标（私信/群聊）独立缓存和发送

### style（样式/格式优化）
- 优化战绩推送模板标题显示

### refactor（重构）
- 优化战绩订阅推送代码结构
- 优化战绩查询代码结构

## [1.2.9-2] - 历史版本

### fix（问题修复）
- 优化帮助系统
  - 添加图片文件存在性检查，图片不存在时记录警告日志
  - 提升帮助系统主题图片加载的可靠性

### style（样式/格式优化）
- 优化大红收藏模板（`redCollection`）
  - 修复文字被裁剪问题，调整文本容器高度和溢出处理
  - 修复异常换行问题，所有文本元素设置为不换行（`white-space: nowrap`）
  - 物品名称使用省略号处理溢出（`text-overflow: ellipsis`）
  - 调整统计卡片大小和位置，优化视觉对齐
  - 将模板宽度从 1125px 调整为 1220px，按比例放大所有内容元素
  - 修复页脚被遮挡问题，调整页脚定位和层级
  - 修复图片右侧空白区域问题，优化容器宽度和布局
  - 移除响应式代码和交互效果（hover、transition 等）
  - 移除所有自动换行设置，统一使用单行显示
- 优化出红记录相关模板
  - 优化 `redRecord` 和 `redRecordList` 模板宽度，减少两侧空隙
  - 调整容器宽度和 padding，提升内容显示区域

### refactor（重构）
- 重构模板依赖结构
  - 将所有模板独立开来，不再依赖外部 `common` 文件夹
  - 创建内部 `Template/common` 模板，统一管理共享样式和 HTML 结构
  - 移除所有模板中的 `!important` 声明，优化 CSS 优先级
  - 统一所有模板的页脚样式和显示方式

## [1.2.9-1] - 历史版本
- 优化大红收藏模板

## [1.2.9-0] - 历史版本

### style（样式）
- 优化多个模板
  - 若头部头像不显示则自动显示发送命令用户的头像
- 更新昨日收益模板
  - 增加物品图片显示

## [1.2.8-0] - 历史版本

### style（样式/格式优化）
- 优化 日报/周报 样式
  - 增加数据时间显示
  - 增加无数据时显示暂无数据
- 重写个人数据页面

### refactor（重构）
- 优化多个文件 优化过度提取

## [1.2.7-0] - 历史版本

### style（样式/格式优化）
- 优化日报模板样式，参考周报模板进行统一
  - 统一标题样式：将"当日最佳"和"近期高价值物资"标题改为与周报一致的样式（白色文字、半透明黑色背景、圆角）
  - 优化标题位置：标题与"最近带出总价值"对齐（margin-left: 8px）
  - 优化物资列表布局：物资图片、名称、价格在同一行显示
  - 优化物资容器：将"近期高价值物资"标题和物资列表放在同一容器中，添加背景和圆角
  - 移除"当日最佳"卡片顶部绿色边框
  - 移除干员卡片中的干员名称显示
  - 优化单模式查询显示：动态调整总宽度和Logo/标题大小
  - 调整"日报"标题位置：向右移动10px，调整字体大小
- 优化当日最佳卡片样式
  - 添加背景地图显示（使用地图图片作为卡片背景）
  - 调整背景地图透明度，优化显示效果
  - 缩小标题和内容之间的间距
- 优化周报样式
  - 修复干员统计卡片宽度超出问题，调整 flex 布局使卡片自适应容器宽度
- 缩小战绩干员图片大小
  - 优化干员图片显示尺寸，提升页面布局紧凑性

### fix（问题修复）
- 修复战绩推送去重机制
  - 将去重机制从内存 Map 改为 Redis 持久化存储，防止重启后重复推送
  - 优化 recordId 生成方式，包含更多唯一标识字段（地图ID、干员ID、时间、分数/价值）
  - 去重记录保存24小时，过期后自动删除
- 修复时长显示问题
  - 当时长为0时显示"0秒"而不是"未知"
  - 添加时长无效时的警告日志
- 修复战绩推送数据处理
  - 兼容处理 isNew 字段缺失的情况，使用 isRecent 字段判断
  - 优化数据获取和处理的日志记录
- 修复日报推送图片发送和数据问题
  - 修复图片发送方式，将图片和文本合并为一条消息发送（之前可能分开发送导致图片丢失）
  - 添加用户头像和用户名的获取（通过 getPersonalInfo API）
  - 添加物品图片处理（优先使用 item.pic，否则从 objectID 构造 URL）
  - 添加地图背景图片路径（使用 DataManager.getMapImagePath）
  - 添加 decodeUserInfo 方法用于 URL 解码
- 修复周报推送图片发送和数据缺失问题
  - 修复图片发送方式，将两条消息合并为一条消息发送（@用户、文本、图片合并发送）
  - 添加用户头像和用户名的获取（通过 getPersonalInfo API）
  - 添加段位图片路径（rankImagePath）支持
  - 添加最常用地图和干员图片路径（mostUsedMapImagePath、mostUsedOperatorImagePath）
  - 添加干员列表和地图列表的图片路径（imagePath）
  - 添加战场干员统计图片路径（operatorStats.imagePath）
  - 完善资产趋势处理，与手动查询保持一致（包含7天数据、折线路径、坐标点等）
  - 添加日期字段（date）处理
  - 添加 decodeUserInfo 方法用于 URL 解码
  - 日报和周报推送现在能正确发送和显示所有图片（地图、干员、段位等）

### refactor（重构）
- 移除地图名称映射代码
  - 移除所有文件中的"沟壕战"->"堑壕战"映射逻辑
  - 数据源已统一使用"堑壕战"，无需额外转换
  - 简化代码逻辑，提升可维护性
  - 涉及文件：Weekly.js、Daily.js、Record.js、RecordSubscription.js、DailyPush.js
- 优化战绩推送日志系统
  - 移除冗余的成功推送日志
  - 保留关键的错误和警告日志
  - 添加必要的调试日志（debug级别）
  - 优化日志级别，提升可读性

## [1.2.6] - 历史版本

### style（样式/格式优化）
- 优化周报样式
  - 修复干员统计卡片宽度超出问题，调整 flex 布局使卡片自适应容器宽度
- 缩小战绩干员图片大小
  - 优化干员图片显示尺寸，提升页面布局紧凑性

## [1.2.5] - 历史版本

### feat（新功能）
- 周报和日报推送功能改为使用模板渲染，以图片形式发送
  - 周报推送（`WeeklyPush.js`）使用 `weeklyReport` 模板渲染
  - 日报推送（`DailyPush.js`）使用 `dailyReport` 模板渲染
  - 推送消息从纯文本/转发消息改为图片展示，视觉效果更佳
  - 推送内容与手动查询展示方式保持一致
- 日报藏品区域增加物资图片展示功能

### style（样式/格式优化）
- 增加周报模板（`weeklyReport.html` 和 `weeklyReport.css`）
- 优化日报和周报头部区域显示
  - 增加用户头像显示（圆形头像，带绿色边框和发光效果）
  - 优化用户名和日期显示样式
    - 用户名：白色、加粗、更大字号（16px）、文字阴影效果
    - 日期：绿色高亮、加粗、发光效果
    - 改为垂直排列，信息更清晰
  - 周报头部"周报"文字位置调整（右移，left: 65%）
  - 用户名和日期左对齐显示
- 优化日报藏品区域布局
  - 物品图片显示在左侧（48x48像素）
  - 物品名称和价格信息在右侧
  - 优化间距和对齐方式

### refactor（重构）
- 重构帮助配置系统
  - 将所有帮助移动至 `config/help` 文件夹下 并且增加 `_default` 后缀
- 优化用户头像获取方式
  - 日报和周报统一使用 `getPersonalInfo` API 获取用户信息

### fix（问题修复）
- 修复 Config.js 中自动创建 config.yaml 时的错误处理
  - 添加 config_default.yaml 存在性检查，避免文件不存在时导致插件加载失败
  - 添加完整的错误处理机制，确保异常情况下插件仍能正常加载
- 更新 .gitignore，排除自动从 API 生成的数据文件
  - 添加 maps.yaml、operators.yaml、rankscore.yaml、audio_data.yaml 到忽略列表
  - 这些文件会自动从 API 下载，无需提交到版本控制
- 优化日志提示，确保 API Key 未配置的提示只显示一次
  - 在 Data.js 中添加统一的 showApiKeyWarning() 函数，避免重复提示
  - 在 Code.js 中添加统一的 showApiKeyWarning() 函数，避免重复提示
  - 使用标志变量确保每种数据类型只提示一次，提升日志可读性

## [1.2.4] - 历史版本

### style（样式/格式优化）
- 统一项目字体系统，所有模板和帮助页面使用项目自带字体（`p-med.ttf` 和 `p-bold.ttf`）
- 在 `common/common.css` 中定义统一的 `@font-face` 字体声明
- 更新所有模板 CSS 文件，统一使用 `ProjectD` 字体族
- 更新帮助页面配置文件（`config.yaml`），使用项目默认字体
- 更新 `StyleConfig.js` 默认字体配置
- 优化大红收藏记录模板（`redRecord.html`）样式
- 优化出红记录列表模板（`redRecordList.html`）样式
- 优化大红收藏海报模板（`redCollection.html`）样式
- 优化战绩和推送战绩模板的干员图片显示
- 统一所有模板的页脚样式
- 优化用户信息区域显示
- 完全重写音乐列表模板（`musicList.html` 和 `musicList.css`）
- 优化个人数据统计模板（`personalData.html`）
    - 改为左右两列布局（烽火地带和全面战场并排显示）
    - 优化头部布局，logo 在左，标题在右，同一行显示

### refactor（重构）
- 重构字体引用系统，移除对不存在字体文件的引用
- 统一字体命名规范，使用 `ProjectD` 作为主字体族名
- 合并 `red.js` 和 `RedCollection.js` 为统一文件，消除重复代码
    - 将 `getRedCollection()` 方法合并到 `red.js`，支持两种数据源
    - 提取公共方法 `parseUserInfo()`，统一用户信息解析逻辑
    - 根据命令参数自动选择数据源（出红记录 vs 收藏品详情）
    - 删除 `RedCollection.js` 文件，减少维护成本
- 重构出红记录功能，创建专用列表模板
    - 出红记录使用新的 `redRecordList.html` 模板，以列表形式展示
    - 大红收藏使用 `redCollection.html` 模板，保持原有海报样式
    - 根据数据源类型自动选择对应模板进行渲染
- 统一模板图标和品牌标识
    - 将所有模板中的图标和"三角洲行动"文字替换为统一的 `logo.png` 图片
    - 更新 `redRecord`、`redRecordList` 模板的图标显示方式
- 优化段位显示系统
    - 在 `redRecord`、`redRecordList`、`redCollection` 模板中添加段位图标显示
    - 段位图标仅使用 sol 模式（烽火地带），与游戏模式对应
    - 更新 `parseUserInfo()` 方法，自动获取段位图标路径

### fix（问题修复）
- 修复出红记录列表显示条数，默认显示前 6 条记录（按价值排序）
- 修复模板容器宽度问题，确保左右空隙对称
- 修复数字显示超出和对齐问题，确保在统计卡片上正确居中显示
- 修复战绩订阅推送日志，添加模式信息（烽火地带/全面战场）便于排查问题
    - 在所有关键日志中添加模式标识，区分烽火地带和全面战场推送
    - 优化推送处理日志，明确显示每条推送的模式类型
- 修复 `redCollection` 模板页脚位置问题，优化内容与页脚的间距

### perf（性能优化）
- 优化更新日志显示，仅显示当前版本和上一个版本，减少渲染内容

## [1.2.3] - 历史版本

### feat（新功能）
- 订阅战绩功能支持返回图片展示
- 更新 Guoba Web 配置
- 更新战绩背景显示地图
- 增加大红藏品图片渲染、大红查询图片渲染

### refactor（重构）
- 优化 resources 文件夹内的图片文件存储结构，全部移动至 imgs 文件夹内
- 优化配置文件存放逻辑，区分默认配置与用户配置
    - 外层 `config/` 存放默认配置（提交到 Git）
    - 内层 `config/config/` 存放用户配置和运行时生成的数据（不提交）
    - 订阅配置自动迁移到新目录

### style（样式/格式优化）
- 优化大红藏品查询模板样式

### chore（其他）
- 更新 `.gitignore` 规则，完善忽略配置

## [1.2.2] - 历史版本

### feat（新功能）
- 帮助菜单支持动态配置文件（`help.yaml`）
- 支持帮助配置热重载，修改配置文件后无需重启插件
- API 基础地址管理支持多模式（`auto`, `default`, `eo`, `esa`）
- API 自动故障转移机制，支持 `auto` 模式下的自动切换
- 帮助菜单分为两个独立页面（`^帮助` 和 `^娱乐帮助`）
- 帮助菜单支持两列布局配置
- 帮助组支持 `fullWidth` 属性，可跨两列显示
- 帮助组支持 `column` 属性，可指定显示在左列或右列
- 帮助组支持 `masterOnly` 属性，仅主人可见
- 帮助菜单支持多主题配置系统（`resources/help/imgs/` 目录）
- 帮助菜单样式配置支持热重载（`config.yaml`）
- 帮助菜单样式配置支持字体、字体大小等自定义
- 更新日志使用可视化模板渲染（`version-info.html`）
- 战绩查询使用可视化模板渲染（`record.html`），支持科技风卡片展示
- 个人数据统计使用可视化模板渲染（`personalData.html`），支持双栏布局
- 音乐列表使用可视化模板渲染（`musicList.html`），支持封面展示和排行榜

### refactor（重构）
- 重构 apps 目录结构，按功能分类组织文件
- 重构帮助菜单样式配置系统，从 JavaScript 迁移到 YAML
- 重构战绩查询功能，从纯文本转发消息迁移到可视化模板
- 重构个人数据统计功能，从纯文本消息迁移到可视化模板

### style（样式/格式优化）
- 优化帮助菜单布局，合并相似功能组
- 优化帮助菜单分组，提高可读性
- 优化帮助菜单配置结构，移除未使用的配置项
- 优化帮助菜单资源路径，支持主题动态切换
- 优化帮助菜单背景图片加载，使用绝对路径确保资源正确显示
- 优化帮助菜单左右列平衡，实现每列约18行命令的均衡布局
- 优化帮助菜单组排序，支持 `order` 属性精确控制显示顺序
- 优化帮助菜单全宽组显示，支持顶部和底部分区渲染
- 优化更新日志显示配色，采用金黄色主题与背景协调
- 优化更新日志卡片透明度，增强毛玻璃效果
- 优化更新日志视觉层次，提升阴影和圆角效果
- 优化更新日志文字可读性，调整颜色和行高
- 优化战绩卡片整体视觉设计，采用半透明背景和毛玻璃效果
- 优化战绩状态标签，撤离成功显示绿色，失败显示红色，退出显示橙色
- 优化战绩卡片布局，修复左右内边距不对称问题（统一为20px）
- 战绩卡片支持动态地图背景图，根据地图名称自动匹配对应背景
- 战绩卡片支持动态干员图片，显示在右侧并带有从左到右的渐变遮罩效果
- 优化战绩击杀数据展示，干员击杀显示绿色，AI玩家击杀显示红色，其他AI击杀显示橙色

### perf（性能优化）
- 优化 API 请求错误处理和重试机制
- 优化日志系统，减少冗余日志输出
- 调整日志等级，提升日志可读性
- 优化数据管理器初始化日志
- 优化 JSON 数据加载状态显示
- 优化数据同步日志输出，将详细信息改为 debug 级别
- 优化更新日志显示，使用模板渲染替代纯文本

### fix（问题修复）
- 修复帮助菜单显示过长的问题
- 修复帮助菜单列宽计算问题
- 修复两列布局不平衡的问题
- 修复个人信息页面时间显示格式问题
- 修复时间显示换行问题，增加宽度并防止换行
- 修复文件移动后导入路径错误的问题

## [1.2.1 ~ 1.0.0] - 早期版本

### 基础功能...

---

## 版本号更新规则

版本号遵循扩展的语义化版本规范，格式为 `主版本号.次版本号.修订号-补丁号`（MAJOR.MINOR.PATCH-BUILD）：

- **主版本号（MAJOR）**：当进行不兼容的 API 变更或重大架构调整时递增，例如 `1.2.6-0` → `2.0.0-0`
- **次版本号（MINOR）**：当添加向下兼容的新功能时递增，PATCH 和 BUILD 归零，例如 `1.2.6-0` → `1.3.0-0`
- **修订号（PATCH）**：当进行向下兼容的问题修复或样式优化时递增，BUILD 归零，例如 `1.2.6-0` → `1.2.7-0`
- **补丁号（BUILD）**：当进行小的修复、样式微调或日志优化时递增，例如 `1.2.7-0` → `1.2.7-1`

### 版本号更新时机

- **仅修复（fix）**：更新 PATCH，如 `1.2.6-0` → `1.2.7-0`
- **样式优化（style）**：更新 PATCH，如 `1.2.6-0` → `1.2.7-0`
- **新增功能（feat）**：更新 MINOR，如 `1.2.6-0` → `1.3.0-0`
- **重大变更或优化**：通常更新 MINOR，如 `1.2.6-0` → `1.3.0-0`
- **不兼容变更**：更新 MAJOR，如 `1.2.6-0` → `2.0.0-0`
- **小修复或微调**：更新 BUILD，如 `1.2.7-0` → `1.2.7-1`

### 更新 CHANGELOG 的步骤

1. 在文件顶部添加新版本条目：`## [新版本号] - 发布日期或"未发布"`
2. 将当前版本内容移到新版本下
3. 同步更新 `package.json` 中的 `version` 字段
4. 将旧版本条目移动到历史版本部分

## 更新类型说明

遵循 [Conventional Commits](https://www.conventionalcommits.org/) 规范：

- **feat**: 新功能（feature）
- **fix**: 问题修复（bug fix）
- **docs**: 文档更新（documentation）
- **style**: 代码格式、样式调整（不影响代码运行的变动）
- **refactor**: 代码重构（既不是新功能也不是 bug 修复）
- **perf**: 性能优化（performance）
- **test**: 测试相关（tests）
- **chore**: 构建过程或辅助工具的变动
- **build**: 构建系统或外部依赖的变更
- **ci**: CI 配置文件和脚本的变更
- **revert**: 回滚之前的 commit

